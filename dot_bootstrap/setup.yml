- name: Machine setup
  hosts: localhost
  become: false
  gather_facts: yes

  vars:
    Brew_packages: "{{ lookup('file', '~/.local/share/chezmoi/dot_bootstrap/brew_packages').split('\n') }}"
    Brew_cask_packages: "{{ lookup('file', '~/.local/share/chezmoi/dot_bootstrap/brew_cask_packages').split('\n') }}"
    nerd_fonts_dir: "{{ lookup('file', '~/fonts') }}"
    nerd_fonts_version: "v3.1.1"

  tasks:
    - name: Run softwareupdate command
      command: softwareupdate --install-rosetta --agree-to-license
      changed_when: false

    - name: Download Nerd Fonts
      get_url:
        url: "https://github.com/ryanoasis/nerd-fonts/releases/download/{{ nerd_fonts_version }}/JetBrainsMono.zip"
        dest: "{{ nerd_fonts_dir }}/nerd-fonts.zip"

    - name: Unzip Nerd Fonts
      command: "unzip -o '{{ nerd_fonts_dir }}/nerd-fonts.zip' -d '{{ nerd_fonts_dir }}'"

    - name: Install Nerd Fonts
      command: "cp -r '{{ nerd_fonts_dir }}'/*.ttf ~/Library/Fonts/"
      changed_when: false

    - name: Check if Homebrew is installed
      stat:
        path: /opt/homebrew/bin/brew
      register: brew_check
      changed_when: false
      failed_when: false
      ignore_errors: true

    - name: Install Homebrew if not installed
      when: brew_check.stat.exists
      become: yes
      shell: >
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    - name: Install Homebrew packages
      community.general.homebrew:
        name: "{{ item }}"
        state: present
      loop: "{{ Brew_packages }}"
      when: brew_check.stat.exists

    - name: Install Homebrew casks
      community.general.homebrew_cask:
        name: "{{ item }}"
        state: present
      loop: "{{ Brew_cask_packages }}"
      when: brew_check.stat.exists
